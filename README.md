# 医療紹介状→初診カルテ変換アプリ（複数ファイル対応版）

## 🎉 新機能：複数ファイル同時アップロード

紹介状が複数ページに分かれている場合や、検査結果などの関連資料がある場合でも、**一度に全てのファイルをアップロードして処理できます！**

### 複数ファイル対応のメリット

#### 📸 こんな場合に便利
1. **紹介状が複数ページの場合**
   - 1ページ目: 患者基本情報
   - 2ページ目: 検査結果  
   - 3ページ目: 処方内容
   - → 全てを一度にアップロードすれば、AIが自動で統合して1つの初診カルテを作成

2. **関連資料が複数ある場合**
   - 紹介状本体
   - 血液検査結果
   - 画像検査レポート
   - 心電図結果
   - → 関連する全ての資料を一括処理

3. **スマホ撮影で複数枚に分かれた場合**
   - A4の紹介状をスマホで2枚に分けて撮影
   - PDFと画像が混在
   - → まとめてアップロードOK

### 複数選択の方法
- **Windows**: `Ctrl` + クリック
- **Mac**: `Cmd` + クリック  
- **連続選択**: `Shift` + クリック

## 従来からの改善点

実際の医療現場で使用されている初診カルテの形式に準拠した、より正確な情報抽出システムです。

### 主な改善点

#### 1. **SOAP形式への完全準拠**
添付ファイルの初診カルテで使用されているSOAP形式（Subjective, Objective, Assessment, Plan）に完全対応しました。

- **S (Subjective)**: 患者・家族の訴え、主訴
- **O (Objective)**: 
  - 意識レベル（意識清明など）
  - 全身状態
  - 身体所見（心音、呼吸音、腹部所見など）
  - 検査結果（心電図、画像所見、血液検査など）
- **A (Assessment)**: 診断名、病状評価
- **P (Plan)**: 治療計画、紹介先

#### 2. **病名の正確な記載**
実際の医療現場と同じく、病名には必ず「#」を付けて記載します。

```
例：
#アルツハイマー型認知症
#高血圧症
#虚血性心疾患
```

#### 3. **認知症評価の詳細化**
MMSEスコアを含む、認知症の包括的な評価項目を追加：

- 認知症の有無と種類
- 重症度（軽度/中等症/重度、またはⅠ〜Ⅳ、M）
- **MMSE得点**（例: "16/30" または "16点（30点）"）
- 周辺症状（BPSD）の内容

#### 4. **ADL評価の詳細化**
実際の訪問診療で必要とされる詳細なADL評価：

- 歩行：独歩/杖歩行/歩行器/車椅子/寝たきり
- 食事：自立/一部介助/全介助
- 排泄：自立/一部介助/全介助/おむつ/カテーテル
- 入浴：自立/一部介助/全介助
- 着衣：自立/一部介助/全介助
- 日常動作：自立度の記載
- IADL：手段的日常生活動作

#### 5. **ACP（アドバンス・ケア・プランニング）の充実**
添付ファイルに記載されている詳細な意思決定項目を網羅：

- 急変時対応（DNRなど）
- 延命治療の意向
- 経管栄養・胃瘻の希望
- 治療可能な急性疾患への対応
- 入院の希望
- 臓器提供・ブレインバンク登録

#### 6. **服薬情報の分類**
定期内服薬と頓服薬（屯用薬）を明確に分類：

- **定期内服薬**: 毎日服用する薬
- **頓服・屯用薬**: 症状時や必要時に使用する薬（使用条件も含む）

#### 7. **経過概略の構造化**
時系列での病歴を構造化：

- 発症と経過：いつから、どのように進行したか
- 紹介理由：今回の紹介に至った経緯
- 最近の変化：直近で起きた変化

#### 8. **介護情報の充実**
在宅医療に不可欠な社会的背景情報：

- 要介護度（要支援1〜2、要介護1〜5）
- 障害者手帳の等級
- 家族構成
- キーパーソン（氏名・続柄・連絡先）
- 利用中の介護サービス
- 本人が過ごしたい場所

#### 9. **バイタルサインの明示**
初診時のバイタル情報を個別に記録：

- 身長、体重
- 血圧、脈拍
- 体温、SpO2

#### 10. **アレルギー・副作用歴の詳細化**
医療安全に重要な情報を明確に分類：

- 薬剤アレルギー
- 食物アレルギー
- 喘息の有無
- 副作用歴（薬剤と症状）

## 使い方

### セットアップ

```bash
# 依存パッケージのインストール
pip install -r requirements.txt

# Google Gemini APIキーの設定
# .streamlit/secrets.toml に以下を記載
# GOOGLE_API_KEY = "your-api-key-here"

# アプリの起動（複数ファイル対応版）
streamlit run app_multi_upload.py
```

### 複数画像から抽出

1. 「📷 画像アップロード」タブを選択
2. 紹介状の写真やPDFを複数選択（Ctrl/Cmd + クリック）
3. プレビューで内容を確認
4. 「🔍 全ファイルから情報を抽出して初診カルテを作成」ボタンをクリック
5. AIが全てのファイルを読み込んで統合し、実際の初診カルテ形式で結果が表示されます

### テキストから抽出

1. 「📝 テキスト入力」タブを選択
2. 紹介状のテキストを貼り付け
3. 「🔍 情報を抽出して初診カルテを作成」ボタンをクリック
4. 実際の初診カルテ形式で結果が表示されます

## 対応ファイル形式

- **画像**: JPG, JPEG, PNG
- **文書**: PDF
- **複数ファイル**: 上記形式を組み合わせて同時アップロード可能

## 表示形式

抽出された情報は、実際の初診カルテと同じ構造で表示されます：

1. **患者基本情報**: 氏名、生年月日、年齢、性別
2. **バイタルサイン**: 身長、体重、血圧、脈拍、体温、SpO2
3. **SOAP**: S/O/A/P の4項目で構造化
4. **病名**: # 付きで列挙
5. **経過概略**: 発症・経過、紹介理由、最近の変化
6. **既往歴・アレルギー・生活歴**: 詳細な医療歴
7. **ADL・IADL**: 日常生活動作の詳細評価
8. **認知症評価**: MMSE含む包括的評価
9. **介護情報**: 要介護度、家族構成、キーパーソン
10. **ACP**: 詳細な意思決定内容
11. **服薬情報**: 定期薬と頓服薬を分類
12. **治療計画**: 今後の方針

## 技術スタック

- **Frontend**: Streamlit
- **AI Model**: Google Gemini 2.5 Flash
- **Image Processing**: Pillow (PIL), pdf2image
- **Data Display**: Pandas

## 複数ファイル処理の仕組み

1. **ファイル読み込み**
   - PDFは自動的に画像に変換
   - 画像ファイルはそのまま読み込み
   - 全てのページ/画像を統合

2. **AI処理**
   - Gemini 2.5 Flashに全ての画像を一度に送信
   - AIが複数ページの情報を統合して解析
   - 重複情報は自動的に統合

3. **結果出力**
   - 統合された1つの初診カルテとして出力
   - SOAP形式で構造化された見やすい表示
   - テキスト形式でコピペも可能

## 医療現場での活用

このシステムは以下のような場面で活用できます：

1. **訪問診療開始時**: 紹介状から初診カルテを自動作成
2. **診療所間の連携**: 他院からの紹介状を効率的に取り込み
3. **入院・転院時**: 患者情報の迅速な把握と記録
4. **カンファレンス準備**: 患者情報の構造化と共有
5. **複数検査結果の統合**: バラバラの検査結果を1つのカルテに集約

## 注意事項

- このアプリはデモ・研究用です
- 実際の医療現場での使用には、医療機器としての承認や個人情報保護対策が必要です
- 抽出結果は必ず医療従事者が確認・修正してください
- APIキーは厳重に管理し、外部に公開しないでください
- ファイルサイズは合計で20MB程度まで推奨

## よくある質問

### Q: 何枚まで同時にアップロードできますか？
A: 技術的には制限はありませんが、処理速度とAPI制限の観点から、10ファイル程度までを推奨します。

### Q: PDFと画像を混在させてもいいですか？
A: はい、問題ありません。PDFは自動的に画像に変換されて処理されます。

### Q: 複数の患者の紹介状を同時に処理できますか？
A: いいえ、このアプリは1人の患者の情報を複数ファイルから統合することを想定しています。複数患者の処理には対応していません。

### Q: ファイルの順序は重要ですか？
A: AIは全てのファイルの内容を総合的に判断するため、順序は特に重要ではありません。

## 今後の拡張可能性

- [ ] 検査データの自動グラフ化
- [ ] 過去カルテとの差分表示
- [ ] 服薬情報の相互作用チェック
- [ ] 電子カルテシステムへの直接入力
- [ ] 音声入力対応
- [ ] 多言語対応
- [ ] バッチ処理（複数患者の一括処理）
- [ ] OCR精度向上のための前処理

## ファイル一覧

- `app_multi_upload.py`: 複数ファイル対応版のメインアプリ
- `app.py`: オリジナル版（単一ファイル）
- `voice_soap.py`: 音声からSOAP形式カルテ作成
- `requirements.txt`: 必要なパッケージ
- `packages.txt`: システムパッケージ

## ライセンス

医療ハッカソン デモアプリケーション